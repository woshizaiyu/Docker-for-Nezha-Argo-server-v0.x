name: Koyeb Service Keep Alive - Ping with Telegram Notify

on:
  schedule:
    - cron: '*/35 * * * *'   # æ¯ 25 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆé˜² 60min ä¼‘çœ ï¼‰
  workflow_dispatch:         # æ‰‹åŠ¨æµ‹è¯•

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Koyeb service
        id: ping
        run: |
          URL="https://wee-casey-1matrixarchitectur-0d99d90a.koyeb.app"  # â† å¿…é¡»æ”¹æˆä½ çš„çœŸå® URLï¼
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -m 15 "$URL" || echo "999")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "Ping to $URL â†’ HTTP $RESPONSE"

      - name: Send Telegram Notification
        if: always()  # å³ä½¿ ping å¤±è´¥ä¹Ÿå‘é€šçŸ¥
        run: |
          RESPONSE="${{ steps.ping.outputs.response }}"
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "302" ]; then
            STATUS="âœ… æœåŠ¡ ping æˆåŠŸ (HTTP $RESPONSE)"
            EMOJI="ğŸŸ¢"
          elif [ "$RESPONSE" = "999" ]; then
            STATUS="âŒ curl æ‰§è¡Œå¼‚å¸¸ï¼ˆè¶…æ—¶æˆ–ç½‘ç»œé—®é¢˜ï¼‰"
            EMOJI="ğŸ”´"
          else
            STATUS="âš ï¸ æœåŠ¡å“åº”å¼‚å¸¸ (HTTP $RESPONSEï¼Œå¯èƒ½å·²ä¼‘çœ æˆ–å‡ºé”™)"
            EMOJI="ğŸŸ "
          fi

          TIME_NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          MESSAGE="ğŸ•’ Koyeb æœåŠ¡ä¿æ´»æ£€æŸ¥ ($TIME_NOW)\n\n$EMOJI $STATUS\nURL: ${{ steps.ping.outputs.url || 'æœªå®šä¹‰' }}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
