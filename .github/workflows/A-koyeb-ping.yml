name: Koyeb Service Keep Alive - Ping with Telegram Notify

on:
  schedule:
    - cron: '5,25,45 * * * *'   # ä¸»ï¼šæ¯20åˆ†é’Ÿï¼ˆ5/25/45ï¼‰ï¼Œé—´éš”20minï¼Œé¿å¼€:00/:30é«˜è´Ÿè½½
    - cron: '15,35,55 * * * *'  # å¤‡1ï¼šæ¯20åˆ†é’Ÿï¼ˆ15/35/55ï¼‰ï¼Œé”™å¼€ä¸»8â€“10min
    - cron: '8,38 * * * *'      # å¤‡2ï¼šæ¯30åˆ†é’Ÿï¼ˆ8/38ï¼‰ï¼Œé¢å¤–å†—ä½™
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Log Current Time for Interval Check
        run: |
          echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC") - Workflow started (UTC time)"

      - name: Random Jitter to Avoid Queue Congestion
        run: |
          sleep $((RANDOM % 300))  # éšæœº sleep 0-5åˆ†é’Ÿï¼Œæ•£å¼€é«˜è´Ÿè½½é˜Ÿåˆ—

      - name: Ping Koyeb service with health check
        id: ping
        run: |
          URL="https://wee-casey-1matrixarchitectur-0d99d90a.koyeb.app"  # å·²æ›¿æ¢æˆä½ æŒ‡å®šçš„ Koyeb åŸç”Ÿ URL
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -m 15 -L --fail "$URL" || echo "999")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "Ping to $URL â†’ HTTP $RESPONSE"

      - name: Debug before send
        run: |
          echo "RESPONSE from ping: ${{ steps.ping.outputs.response }}"
          echo "TG_BOT_TOKEN length: ${#TG_BOT_TOKEN}"
          echo "TG_CHAT_ID first 4 chars: ${TG_CHAT_ID:0:4}"

      - name: Send Telegram Notification
        if: always()
        run: |
          RESPONSE="${{ steps.ping.outputs.response }}"
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "302" ] || [ "$RESPONSE" = "404" ]; then
            STATUS="æœåŠ¡åœ¨çº¿ âœ…"
            EMOJI="ğŸŸ¢"
            EXTRA="å“åº”æ­£å¸¸ï¼Œæ— éœ€å”¤é†’"
          elif [ "$RESPONSE" = "999" ]; then
            STATUS="Ping å¤±è´¥ âŒ"
            EMOJI="ğŸ”´"
            EXTRA="curl å®Œå…¨æ— æ³•è¿æ¥ï¼ˆæœåŠ¡å¾ˆå¯èƒ½å·²ä¼‘çœ ã€åŸŸåè§£æé—®é¢˜æˆ–ç½‘ç»œå¼‚å¸¸ï¼‰"
          else
            STATUS="å¼‚å¸¸å“åº” âš ï¸"
            EMOJI="ğŸŸ "
            EXTRA="HTTP $RESPONSEï¼ˆæœåŠ¡å¯èƒ½æ­£åœ¨å†·å¯åŠ¨ã€ä¸´æ—¶å‡ºé”™æˆ–é…ç½®é—®é¢˜ï¼‰"
          fi

          TIME_NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          BEIJING_TIME=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S CST")
          NEXT_CHECK=$(date -u -d "+20 minutes" +"%H:%M:%S UTC")

          MESSAGE=$(echo -e \
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
            "ğŸš€ *Koyeb Nezha Dashboard ä¿æ´»æŠ¥å‘Š* ğŸš€\n" \
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" \
            "\n" \
            "ğŸ•’ *UTC æ—¶é—´*ï¼š${TIME_NOW}\n" \
            "ğŸ‡¨ğŸ‡³ *åŒ—äº¬æ—¶é—´*ï¼š${BEIJING_TIME}\n" \
            "\n" \
            "${EMOJI} *å½“å‰çŠ¶æ€*ï¼š**${STATUS}**\n" \
            "   â””â”€ ${EXTRA}\n" \
            "\n" \
            "ğŸŒ *ç›‘æ§åœ°å€*ï¼š[https://wee-casey-1matrixarchitectur-0d99d90a.koyeb.app/](https://wee-casey-1matrixarchitectur-0d99d90a.koyeb.app/)\n" \
            "\n" \
            "â­ *é¢„è®¡ä¸‹æ¬¡æ£€æŸ¥* â‰ˆ ${NEXT_CHECK} (UTC)\n" \
            "\n" \
            "æœåŠ¡ä¿æ´»ä¸­ Â· ä¸€åˆ‡æ­£å¸¸è¿è¡Œä¸­ ğŸ’ª")

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
