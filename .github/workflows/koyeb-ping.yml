name: Koyeb Service Keep Alive - Ping with Telegram Notify

on:
  schedule:
    - cron: '5,25,45 * * * *'   # 主：每20min（5/25/45），避高负载
    - cron: '15,35,55 * * * *'  # 备1：每20min，错开覆盖
    - cron: '8,38 * * * *'      # 备2：每30min，额外保险
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Log Current Time for Interval Check
        run: |
          echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC") - Workflow started (UTC time)"

      - name: Random Jitter to Avoid Queue Congestion
        run: |
          sleep $((RANDOM % 300))  # 随机 sleep 0-5分钟，散开高负载队列

      - name: Ping Koyeb service with health check
        id: ping
        run: |
          URL="https://nezha.lds103.cc.cd/"  # 用 Nezha Dashboard 根路径作为 health check
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -m 15 -L --fail "$URL" || echo "999")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "Ping to $URL → HTTP $RESPONSE"

      - name: Debug before send
        run: |
          echo "RESPONSE from ping: ${{ steps.ping.outputs.response }}"
          echo "TG_BOT_TOKEN length: ${#TG_BOT_TOKEN}"
          echo "TG_CHAT_ID first 4 chars: ${TG_CHAT_ID:0:4}"

      - name: Send Telegram Notification
        if: always()
        run: |
          RESPONSE="${{ steps.ping.outputs.response }}"
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "302" ] || [ "$RESPONSE" = "404" ]; then
            STATUS="服务在线 ✅"
            EMOJI="🟢"
            EXTRA="响应正常，无需唤醒"
          elif [ "$RESPONSE" = "999" ]; then
            STATUS="Ping 失败 ❌"
            EMOJI="🔴"
            EXTRA="curl 超时或网络异常（可能 Koyeb 已休眠）"
          else
            STATUS="异常响应 ⚠️"
            EMOJI="🟠"
            EXTRA="HTTP $RESPONSE（服务可能正在唤醒或出现临时问题）"
          fi

          TIME_NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          BEIJING_TIME=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S CST")
          NEXT_CHECK=$(date -u -d "+20 minutes" +"%H:%M:%S UTC")  # 匹配更短间隔

          # 美化版消息：添加北京时间 + 优化布局
          MESSAGE=$(echo -e \
            "━━━━━━━━━━━━━━━━━━━━━━━━━━━\n" \
            "🚀 *Koyeb Nezha Dashboard 保活报告* 🚀\n" \
            "━━━━━━━━━━━━━━━━━━━━━━━━━━━\n" \
            "\n" \
            "🕒 *UTC 时间*：$TIME_NOW\n" \
            "🇨🇳 *北京时间*：$BEIJING_TIME\n" \
            "\n" \
            "$EMOJI *当前状态*：**$STATUS**\n" \
            "   └─ $EXTRA\n" \
            "\n" \
            "🌐 *监控地址*：[$URL]($URL)\n" \
            "\n" \
            "⏭ *预计下次检查* ≈ $NEXT_CHECK (UTC)\n" \
            "\n" \
            "━━━━━━━━━━━━━━━━━━━━━━━━━━━\n" \
            "服务保活中 · 一切正常运行中 💪")

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
