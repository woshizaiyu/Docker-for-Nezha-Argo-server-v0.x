name: Koyeb Service Keep Alive - Ping with Telegram Notify

on:
  schedule:
    - cron: '*/30 * * * *'           # æ¯30minï¼ˆ0,30ï¼‰ â€“ å¦‚æœå»¶è¿Ÿå¤§ï¼Œå¯æ”¹ '5/30 * * * *'ï¼ˆ5,35ï¼‰
    - cron: '15,45 * * * *'          # å¤‡ï¼š15å’Œ45åˆ†ï¼Œé—´éš”30minï¼Œå®Œç¾é”™å¼€ä¸»ï¼Œé¿å…:00
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Log Current Time for Interval Check
        run: |
          echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC") - Workflow started (UTC time)"

      - name: Random Jitter to Avoid Queue Congestion
        run: |
          sleep $((RANDOM % 300))  # éšæœº sleep 0-5åˆ†é’Ÿï¼Œæ•£å¼€é«˜è´Ÿè½½é˜Ÿåˆ—

      - name: Ping Koyeb service with health check
        id: ping
        run: |
          URL="https://nezha.lds103.cc.cd/"  # ç”¨ Nezha Dashboard æ ¹è·¯å¾„ä½œä¸º health check
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -m 15 -L --fail "$URL" || echo "999")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "Ping to $URL â†’ HTTP $RESPONSE"

      - name: Debug before send
        run: |
          echo "RESPONSE from ping: ${{ steps.ping.outputs.response }}"
          echo "TG_BOT_TOKEN length: ${#TG_BOT_TOKEN}"
          echo "TG_CHAT_ID first 4 chars: ${TG_CHAT_ID:0:4}"

      - name: Send Telegram Notification
        if: always()
        run: |
          RESPONSE="${{ steps.ping.outputs.response }}"
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "302" ] || [ "$RESPONSE" = "404" ]; then
            STATUS="æœåŠ¡åœ¨çº¿ âœ…"
            EMOJI="ğŸŸ¢"
            EXTRA="å“åº”æ­£å¸¸ï¼Œæ— éœ€å”¤é†’"
          elif [ "$RESPONSE" = "999" ]; then
            STATUS="Ping å¤±è´¥ âŒ"
            EMOJI="ğŸ”´"
            EXTRA="curl è¶…æ—¶æˆ–ç½‘ç»œå¼‚å¸¸ï¼ˆå¯èƒ½ Koyeb å·²ä¼‘çœ ï¼‰"
          else
            STATUS="å¼‚å¸¸å“åº” âš ï¸"
            EMOJI="ğŸŸ "
            EXTRA="HTTP $RESPONSEï¼ˆæœåŠ¡å¯èƒ½å¯åŠ¨ä¸­/å‡ºé”™ï¼‰"
          fi

          TIME_NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          NEXT_CHECK=$(date -u -d "+30 minutes" +"%H:%M:%S UTC")  # åŒ¹é…30miné—´éš”

          MESSAGE=$(cat <<EOF
*Koyeb Nezha Dashboard ä¿æ´»æ£€æŸ¥*

ğŸ•’ æ—¶é—´: $TIME_NOW (UTC)

$EMOJI *çŠ¶æ€*: $STATUS
ğŸ“ URL: $URL
ğŸ” è¯¦æƒ…: $EXTRA

é¢„è®¡ä¸‹æ¬¡ â‰ˆ $NEXT_CHECK (UTC)

ä¿æŒåœ¨çº¿ä¸­... ğŸš€
EOF
)

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
