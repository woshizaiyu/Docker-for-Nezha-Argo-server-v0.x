name: Koyeb Service Keep Alive - Ping with Telegram Notify

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿä¸€æ¬¡
    timezone: 'Asia/Shanghai'
  workflow_dispatch:


jobs:
  ping-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Koyeb service
        id: ping
        run: |
          URL="https://wee-casey-1matrixarchitectur-0d99d90a.koyeb.app"  # å¿…é¡»æ”¹ï¼ä¾‹å¦‚ https://nezhaha-argo-ä½ çš„åå­—.koyeb.app
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -m 15 "$URL" || echo "999")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "Ping to $URL â†’ HTTP $RESPONSE"
          
      - name: Debug before send
        run: |
          echo "RESPONSE from ping: ${{ steps.ping.outputs.response }}"
          echo "TG_BOT_TOKEN length: ${#TG_BOT_TOKEN}"   # æ­£å¸¸ > 30
          echo "TG_CHAT_ID first 4 chars: ${TG_CHAT_ID:0:4}"   # å¸® mask ä½†å¯è§å¼€å¤´
          echo "MESSAGE preview: $MESSAGE"

      - name: Send Telegram Notification
        if: always()
        run: |
          RESPONSE="${{ steps.ping.outputs.response }}"
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "302" ] || [ "$RESPONSE" = "404" ]; then
            STATUS="âœ… æœåŠ¡ ping æˆåŠŸ (HTTP $RESPONSE)"
            EMOJI="ğŸŸ¢"
          elif [ "$RESPONSE" = "999" ]; then
            STATUS="âŒ curl æ‰§è¡Œå¼‚å¸¸ï¼ˆè¶…æ—¶æˆ–ç½‘ç»œé—®é¢˜ï¼‰"
            EMOJI="ğŸ”´"
          else
            STATUS="âš ï¸ æœåŠ¡å“åº”å¼‚å¸¸ (HTTP $RESPONSEï¼Œå¯èƒ½å·²ä¼‘çœ æˆ–å‡ºé”™)"
            EMOJI="ğŸŸ "
          fi

          TIME_NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          MESSAGE="ğŸ•’ Koyeb æœåŠ¡ä¿æ´»æ£€æŸ¥ ($TIME_NOW)\n\n$EMOJI $STATUS\nURL: $URL"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
